#!/usr/bin/env python3
"""
æ±½è½¦ç”µæºæµ‹è¯•æ¡†æ¶ - Gitä»“åº“è®¾ç½®å·¥å…·
ä¸“ä¸šç‰ˆï¼šä¿®å¤é¡¹ç›®è·¯å¾„å’Œä»“åº“åç§°é—®é¢˜
ç‰ˆæœ¬: v1.2.0
"""
import os
import sys
import subprocess
import time
import json
import argparse
from pathlib import Path
from typing import Tuple, Dict
from datetime import datetime

class GitSetupTool:
    """Gitä»“åº“è®¾ç½®å·¥å…· - ä¿®å¤ç‰ˆ"""
    
    def __init__(self, username: str, repo_name: str, project_path: Path):
        self.username = username
        self.repo_name = repo_name
        self.project_path = project_path
        self.results = {}
        
        # éªŒè¯é¡¹ç›®è·¯å¾„
        if not self.project_path.exists():
            print(f"âŒ é”™è¯¯: é¡¹ç›®è·¯å¾„ä¸å­˜åœ¨: {self.project_path}")
            sys.exit(1)
        
        os.chdir(self.project_path)
    
    def run_command(self, cmd: str, description: str = "") -> Tuple[bool, str]:
        """è¿è¡Œå‘½ä»¤å¹¶è¿”å›ç»“æœ"""
        try:
            result = subprocess.run(
                cmd,
                shell=True,
                cwd=self.project_path,
                capture_output=True,
                text=True,
                encoding='utf-8',
                errors='ignore',
                timeout=30
            )
            
            success = result.returncode == 0
            output = result.stdout.strip() or result.stderr.strip()
            
            if description:
                self.results[description] = success
            
            return success, output
        except Exception as e:
            return False, str(e)
    
    def check_requirements(self) -> bool:
        """æ£€æŸ¥ç³»ç»Ÿè¦æ±‚"""
        print("1. æ£€æŸ¥ç³»ç»Ÿè¦æ±‚...")
        
        # æ£€æŸ¥Gitå®‰è£…
        success, output = self.run_command("git --version", "Gitå®‰è£…æ£€æŸ¥")
        if success:
            version = output.split()[-1] if output else "æœªçŸ¥"
            print(f"   âœ“ Gitç‰ˆæœ¬: {version}")
        else:
            print("   âœ— Gitæœªå®‰è£…æˆ–ä¸å¯ç”¨")
            return False
        
        print(f"   âœ“ é¡¹ç›®è·¯å¾„: {self.project_path}")
        return True
    
    def configure_user(self) -> bool:
        """é…ç½®ç”¨æˆ·ä¿¡æ¯"""
        print("2. é…ç½®Gitç”¨æˆ·ä¿¡æ¯...")
        
        # è®¾ç½®ç”¨æˆ·å
        name_success, _ = self.run_command(
            f'git config user.name "{self.username}"',
            "ç”¨æˆ·åé…ç½®"
        )
        
        # è®¾ç½®é‚®ç®±
        email = f"{self.username}@users.noreply.github.com"
        email_success, _ = self.run_command(
            f'git config user.email "{email}"',
            "é‚®ç®±é…ç½®"
        )
        
        success = name_success and email_success
        if success:
            print(f"   âœ“ ç”¨æˆ·ä¿¡æ¯é…ç½®æˆåŠŸ")
        else:
            print("   âœ— ç”¨æˆ·ä¿¡æ¯é…ç½®å¤±è´¥")
        
        return success
    
    def initialize_repository(self) -> bool:
        """åˆå§‹åŒ–Gitä»“åº“"""
        print("3. åˆå§‹åŒ–Gitä»“åº“...")
        
        git_dir = self.project_path / ".git"
        if git_dir.exists():
            print("   âœ“ Gitä»“åº“å·²å­˜åœ¨")
            return True
        
        success, output = self.run_command("git init", "ä»“åº“åˆå§‹åŒ–")
        if success:
            print("   âœ“ ä»“åº“åˆå§‹åŒ–æˆåŠŸ")
        else:
            print(f"   âœ— åˆå§‹åŒ–å¤±è´¥: {output}")
        
        return success
    
    def setup_remote_repository(self) -> bool:
        """è®¾ç½®è¿œç¨‹ä»“åº“"""
        print("4. é…ç½®è¿œç¨‹ä»“åº“...")
        
        # æ£€æŸ¥æ˜¯å¦å·²é…ç½®è¿œç¨‹ä»“åº“
        success, output = self.run_command("git remote -v", "è¿œç¨‹ä»“åº“æ£€æŸ¥")
        if success and "origin" in output:
            print("   âœ“ è¿œç¨‹ä»“åº“å·²é…ç½®")
            return True
        
        # æ·»åŠ è¿œç¨‹ä»“åº“
        remote_url = f"https://github.com/{self.username}/{self.repo_name}.git"
        success, output = self.run_command(
            f"git remote add origin {remote_url}",
            "è¿œç¨‹ä»“åº“æ·»åŠ "
        )
        
        if success:
            print("   âœ“ è¿œç¨‹ä»“åº“é…ç½®æˆåŠŸ")
        else:
            print(f"   âœ— è¿œç¨‹ä»“åº“é…ç½®å¤±è´¥: {output}")
        
        return success
    
    def add_and_commit_files(self) -> bool:
        """æ·»åŠ å¹¶æäº¤æ–‡ä»¶"""
        print("5. æäº¤ä»£ç æ–‡ä»¶...")
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å¯æäº¤
        success, output = self.run_command("git status --porcelain", "æ–‡ä»¶çŠ¶æ€æ£€æŸ¥")
        if not success or not output.strip():
            print("   â„¹ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´")
            return True
        
        # è®¡ç®—æ–‡ä»¶æ•°é‡
        file_count = len([line for line in output.strip().split('\n') if line.strip()])
        
        # æ·»åŠ æ‰€æœ‰æ–‡ä»¶
        add_success, _ = self.run_command("git add .", "æ–‡ä»¶æ·»åŠ ")
        if not add_success:
            print("   âœ— æ–‡ä»¶æ·»åŠ å¤±è´¥")
            return False
        
        # æäº¤æ–‡ä»¶
        commit_message = f"""åˆå§‹æäº¤: æ±½è½¦ç”µæºè‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶

é¡¹ç›®: {self.repo_name}
æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}
æè¿°: 48Vç”µæºæ¨¡å—è‡ªåŠ¨åŒ–æµ‹è¯•å¹³å°
"""
        
        commit_success, _ = self.run_command(
            f'git commit -m "{commit_message}"',
            "ä»£ç æäº¤"
        )
        
        if commit_success:
            print(f"   âœ“ æäº¤æˆåŠŸ ({file_count} ä¸ªæ–‡ä»¶)")
        else:
            print("   âœ— æäº¤å¤±è´¥")
        
        return commit_success
    
    def push_to_github(self, retries: int = 3) -> bool:
        """æ¨é€åˆ°GitHub"""
        print("6. æ¨é€åˆ°GitHub...")
        
        for attempt in range(retries):
            if attempt > 0:
                print(f"   é‡è¯•æ¨é€ ({attempt}/{retries})...")
                time.sleep(2)
            
            success, output = self.run_command(
                "git push -u origin main",
                "ä»£ç æ¨é€"
            )
            
            if success:
                print("   âœ“ æ¨é€æˆåŠŸ")
                return True
            else:
                print(f"   æ¨é€å¤±è´¥: {output[:200]}")
                
                # å¦‚æœæ˜¯non-fast-forwardé”™è¯¯ï¼Œå°è¯•å®‰å…¨å¼ºåˆ¶æ¨é€
                if "non-fast-forward" in output and attempt == retries - 1:
                    print("   å°è¯•å®‰å…¨å¼ºåˆ¶æ¨é€...")
                    force_success, _ = self.run_command(
                        "git push -u origin main --force-with-lease",
                        "å®‰å…¨å¼ºåˆ¶æ¨é€"
                    )
                    if force_success:
                        print("   âœ“ å¼ºåˆ¶æ¨é€æˆåŠŸ")
                        return True
        
        print("   âœ— æ¨é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥:")
        print("     - GitHubä»“åº“æ˜¯å¦å·²åˆ›å»º")
        print("     - ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸")
        return False
    
    def generate_report(self) -> Dict:
        """ç”Ÿæˆæ‰§è¡ŒæŠ¥å‘Š"""
        return {
            "timestamp": datetime.now().isoformat(),
            "project_path": str(self.project_path),
            "github_username": self.username,
            "repository": self.repo_name,
            "results": self.results,
            "success": all(self.results.values())
        }
    
    def run_setup(self) -> bool:
        """è¿è¡Œå®Œæ•´çš„è®¾ç½®æµç¨‹"""
        print("=" * 60)
        print("æ±½è½¦ç”µæºæµ‹è¯•æ¡†æ¶ - Gitä»“åº“è®¾ç½®å·¥å…·")
        print("=" * 60)
        print(f"é¡¹ç›®è·¯å¾„: {self.project_path}")
        print(f"GitHubç”¨æˆ·: {self.username}")
        print(f"ä»“åº“åç§°: {self.repo_name}")
        print("=" * 60)
        
        steps = [
            ("æ£€æŸ¥ç³»ç»Ÿè¦æ±‚", self.check_requirements),
            ("åˆå§‹åŒ–ä»“åº“", self.initialize_repository),
            ("é…ç½®ç”¨æˆ·", self.configure_user),
            ("è®¾ç½®è¿œç¨‹", self.setup_remote_repository),
            ("æäº¤ä»£ç ", self.add_and_commit_files),
            ("æ¨é€ä»£ç ", self.push_to_github),
        ]
        
        for step_name, step_func in steps:
            if not step_func():
                print(f"\nâŒ {step_name}å¤±è´¥ï¼Œç»ˆæ­¢æ‰§è¡Œ")
                return False
            time.sleep(0.5)
        
        return True

def validate_repo_name(repo_name: str) -> str:
    """éªŒè¯å’Œæ¸…ç†ä»“åº“åç§°"""
    # ç§»é™¤å‰åç©ºæ ¼
    repo_name = repo_name.strip()
    
    # GitHubä»“åº“åç§°è§„åˆ™ï¼šåªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€è¿å­—ç¬¦ã€ä¸‹åˆ’çº¿
    import re
    repo_name = re.sub(r'[^a-zA-Z0-9_-]', '-', repo_name)
    
    # ä¸èƒ½ä»¥è¿å­—ç¬¦å¼€å¤´æˆ–ç»“å°¾
    repo_name = repo_name.strip('-')
    
    # ä¸èƒ½ä»¥ç‚¹å¼€å¤´
    repo_name = repo_name.lstrip('.')
    
    # é•¿åº¦é™åˆ¶
    if len(repo_name) > 100:
        repo_name = repo_name[:100]
    
    return repo_name.lower()

def main():
    """ä¸»å‡½æ•°"""
    parser = argparse.ArgumentParser(description="Gitä»“åº“è®¾ç½®å·¥å…·")
    parser.add_argument("--username", help="GitHubç”¨æˆ·å")
    parser.add_argument("--repo", help="ä»“åº“åç§°")
    parser.add_argument("--path", help="é¡¹ç›®è·¯å¾„", default=".")
    
    args = parser.parse_args()
    
    # è·å–é¡¹ç›®è·¯å¾„
    project_path = Path(args.path).resolve()
    
    # äº¤äº’å¼è·å–ç¼ºå¤±çš„ä¿¡æ¯
    if not args.username:
        args.username = input("GitHubç”¨æˆ·å: ").strip()
        if not args.username:
            print("é”™è¯¯: å¿…é¡»æä¾›GitHubç”¨æˆ·å")
            return 1
    
    if not args.repo:
        default_repo = "car_power_auto_platform"
        repo_input = input(f"ä»“åº“åç§° [{default_repo}]: ").strip()
        args.repo = repo_input if repo_input else default_repo
    
    # éªŒè¯å’Œæ¸…ç†ä»“åº“åç§°
    original_repo = args.repo
    args.repo = validate_repo_name(args.repo)
    
    if original_repo != args.repo:
        print(f"âš  ä»“åº“åç§°å·²æ¸…ç†: {original_repo} -> {args.repo}")
    
    # éªŒè¯é¡¹ç›®è·¯å¾„
    if not project_path.exists():
        print(f"âŒ é”™è¯¯: é¡¹ç›®è·¯å¾„ä¸å­˜åœ¨: {project_path}")
        return 1
    
    # è¿è¡Œè®¾ç½®
    tool = GitSetupTool(args.username, args.repo, project_path)
    success = tool.run_setup()
    
    if success:
        print("\n" + "=" * 60)
        print("ğŸ‰ Gitä»“åº“è®¾ç½®å®Œæˆ!")
        print(f"ğŸŒ ä»“åº“åœ°å€: https://github.com/{args.username}/{args.repo}")
    else:
        print("\nâŒ Gitä»“åº“è®¾ç½®å¤±è´¥")
        return 1
    
    return 0

if __name__ == "__main__":
    sys.exit(main())